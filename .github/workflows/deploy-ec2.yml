name: Deploy to EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          command_timeout: 23m
          script: |
            # 1. FIX MEMORY: Auto-create Swap if missing (prevents crash on t2.micro)
            # Check if swap is active
            if [ $(free | awk '/^Swap:/ {print $2}') -eq 0 ]; then
              echo "Swap not found. Auto-creating 2GB Swap Memory..."
              sudo fallocate -l 2G /swapfile
              sudo chmod 600 /swapfile
              sudo mkswap /swapfile
              sudo swapon /swapfile
              # Add to fstab if not present
              if ! grep -q "/swapfile" /etc/fstab; then
                echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
              fi
              echo "Swap created successfully."
            else
               echo "Swap already exists."
            fi

            # 2. Setup Environment
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            
            # 3. Deploy
            mkdir -p ~/dinehub
            cd ~/dinehub
            
            # Check if git initialized
            if [ ! -d ".git" ]; then
              echo "Cloning repository..."
              git clone https://github.com/${{ github.repository }}.git .
            else
              echo "Pulling latest changes..."
              git pull origin main
            fi
            
            echo "Installing dependencies..."
            npm ci
            
            echo "Building application..."
            npm run build
            
            echo "Restarting PM2..."
            pm2 startOrRestart ecosystem.config.js --env prod
            
            echo "Deployment Complete!"
